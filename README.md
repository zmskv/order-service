
# Order Service

Демонстрационный микросервис для обработки и отображения данных заказов.
Сервис принимает сообщения из Kafka, сохраняет их в PostgreSQL, кэширует в памяти и предоставляет HTTP API и веб-интерфейс для получения информации о заказе по ID.

---

## Содержание

* [Описание](#описание)
* [Функциональность](#функциональность)
* [Требования](#требования)
* [Установка и запуск](#установка-и-запуск)
* [Переменные окружения](#переменные-окружения)
* [Makefile команды](#makefile-команды)
* [Использование](#использование)
* [API](#api)
* [Тестирование](#тестирование)
* [Документация](#документация)

---

## Описание

Этот микросервис предназначен для демонстрации основных принципов работы с брокерами сообщений, базой данных и кэшированием.
Сервис получает данные о заказах из Kafka, сохраняет их в PostgreSQL, кэширует последние заказы в памяти для быстрого доступа и предоставляет удобный HTTP API и веб-интерфейс для просмотра информации по заказам.

---

## Функциональность

* Подписка на Kafka-топик с данными заказов.
* Парсинг и валидация сообщений из очереди.
* Сохранение данных в PostgreSQL с применением транзакций.
* Кэширование последних полученных заказов в памяти.
* Восстановление кэша из базы данных при старте сервиса.
* HTTP API для получения данных заказа по `order_id`.
* Веб-интерфейс с формой для ввода ID заказа и отображения результата.
* Обработка ошибок: некорректные сообщения игнорируются с логированием.
* Swagger документация для API.

---

## Требования

* Go 1.20 или новее
* PostgreSQL (локально или удалённо)
* Kafka брокер
* Make
* Docker (рекомендуется для быстрой развёртки БД и Kafka)

---

## Установка и запуск

Например, через Docker Compose:

```bash
docker-compose up -d
```

(Файл `docker-compose.yml` можно создать самостоятельно или использовать готовый для Kafka + Zookeeper.)

---

### 1. Настройка переменных окружения

Создайте файл `.env` в корне проекта с параметрами подключения:

```env
DB_USERNAME=user
DB_PASSWORD=pass
DB_HOST=localhost
DB_PORT=5432
DB_NAME=orderdb
SSL_MODE=disable

KAFKA_BROKERS=localhost:9092
KAFKA_TOPIC=orders
KAFKA_GROUP_ID=order-service-group

HTTP_PORT=8081
```

---

### 2. Установка зависимостей

```bash
make install
```

---

### 3. Применение миграций базы данных

```bash
make migrate-up
```

Для отката миграций:

```bash
make migrate-down
```

---

## Makefile команды

| Команда             | Описание                               |
| ------------------- | -------------------------------------- |
| `make install`      | Скачать зависимости Go                 |
| `make migrate-up`   | Применить миграции к базе данных       |
| `make migrate-down` | Откатить миграции                      |
| `make run`          | Запустить сервис                       |
| `make gen`          | Сгенерировать моки для тестов          |
| `make test`         | Запустить тесты                        |
| `make test100`      | Запустить тесты 100 раз                |
| `make race`         | Запустить тесты с проверкой гонок      |
| `make cover`        | Покрытие кода тестами                  |
| `make swag`         | Сгенерировать Swagger документацию API |

---

## Использование

### HTTP API

Получить данные заказа по ID:

```http
GET http://localhost:8000/order/<order_id>
```

Ответ — JSON с информацией о заказе.

### Веб-интерфейс

Откройте в браузере:

```
http://localhost:3000/
```

Введите ID заказа и нажмите кнопку, чтобы получить информацию.

---

## Тестирование

Сгенерировать моки:

```bash
make gen
```

Запуск тестов:

```bash
make test
```

Тесты с проверкой гонок:

```bash
make race
```

---

## Документация API

Swagger UI доступен по адресу:

```
http://localhost:8000/swagger/index.html
```

Для генерации документации:

```bash
make swag
```

